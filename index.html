<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BlogUp - Home Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/min.js/0.1.0/$.min.js" integrity="sha512-Vk32j+kJ1fSJgeHkuFGOv/yUCplzmJnxxEq4MYkahPvFz6Yc98N616M8XG+mMIz43WGTaAhRloa643yBES75Ww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.7/sweetalert2.min.js" integrity="sha512-csaTzpLFmF+Zl81hRtaZMsMhaeQDHO8E3gBkN3y3sCX9B1QSut68NxqcrxXH60BXPUQ/GB3LZzzIq9ZrxPAMTg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- <script src="sweetalert2.all.min.js"></script> -->
        <script src="sweetalert2@11.js"></script>
           <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="icon" href="./icons8-triller-app-96.png">
</head>
<style>
    body {
        background: #F3F4F6;
    }

    nav {
        background: #7749F8;
    }

    .azaanDash {
        width: 85%;
        margin: 50px auto 0;
        background-color: white;
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .azaanDash button {
        background-color: #7749F8;
        color: white;
        border: none;
        outline: none;
        border-radius: 10px;
        width: 150px;
        font-size: 14px;
        font-weight: bold;
        padding: 7px 0;
        margin-top: 10px;
    }

    .azaanDash input {
        margin-top: 10px;
    }

    .saa-nav {
        height: 70px;
        display: flex;
        align-items: center;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.01);
    }

    .form-control:focus {
        border-color: #7749F8;
        box-shadow: 0px 0px 5px #7749F8;
    }

    textarea {
        margin-top: 10px;
        height: 100px;
        resize: none;
    }

    .myb {
        font-size: 28px;
        padding: 10px 0;
    }
    .cursor{
    cursor: pointer;
}
</style>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="container navbar-nav d-flex justify-content-between mb-2 mb-lg-0 w-100">
                    <div class="">
                        <a class="nav-link fw-bold text-white cursor">Personal Blogging App</a>
                    </div>
                    <div class="">
                        <a class="nav-link text-white cursor" onclick="location.replace('../pages/login/login.html')" id="l">Login</a>
                        <!-- <a class="nav-link text-white cursor" onclick="location.replace('login.html')" id="l">Login</a> -->
                    </div>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid bg-white saa-nav">
        <div class="container">
            <h3 class="fw-bold" id="greeting">Good Morning Readers !</h3>
        </div>
    </div>
    <div class="container"
        style="width: 100%; display: flex; align-items: start; justify-content: flex-start; flex-direction: column;margin: 0 auto; padding:0 10px; margin-top: 40px;">
        <h1 class="myb">All Blogs</h1>
        <div class="container-fluid" style="width: 100%; padding: 0;" id="container">

        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
        <script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>
        <!-- <script src='sweetalert2.all.min.js'></script> -->
        <!-- <script src='sweetalert2.all.min.js'></script> -->

    
        <script src="sweetalert2@11.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
         <script type ="module" >
                import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
import { getFirestore, collection, getDocs, query, orderBy, onSnapshot, getDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
import { getDownloadURL, getStorage, ref } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

const firebaseConfig =  {
    apiKey: "AIzaSyCHzDNPDBzfBLSR86V9L0fhqLwGJOOXBtA",
    authDomain: "again-5f41e.firebaseapp.com",
    databaseURL: "https://again-5f41e-default-rtdb.firebaseio.com",
    projectId: "again-5f41e",
    storageBucket: "again-5f41e.appspot.com",
    messagingSenderId: "193935378121",
    appId: "1:193935378121:web:4d5c29c7d06210a26e2f18"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const auth = getAuth();
var storage = getStorage()


// const querySnapshot = await getDocs(q);
const querySnapshot = await getDocs(collection(db, "blogs"));
querySnapshot.forEach((doc) => {
    getDownloadURL(ref(storage, doc.data().email))
        .then((url) => {
            document.getElementById("container").innerHTML += `<div class="container" style="width: 100%; padding: 0; margin: 0">
  <div class="container-fluid" style="width: 100%; padding: 0; margin: 0">
      <div class="row" style="width: 100%; padding: 0; margin: 0">
          <div class="col-md-12 border border-1 bg-body rounded">
              <div class="blog p-3">
                  <div class="profile d-flex align-items-center" style="border-bottom: 1px solid #eee; padding-bottom: 10px; align-items: center">
                      <div class="imgbox">
                          <img src="${(url) || "https://www.thecakepalace.com.au/wp-content/uploads/2022/10/dummy-user.png"}" class="cursor"
                          height="90px" width="90px" style="object-fit: cover;  border-radius: 50%;" onclick="goTo('${doc.data().email}','${url}')">
                      </div>
                      <div class="userbox ms-3 ps-3" style="border-left: 1px solid #eee;">
                          <h3 id="blog-title" style="font-size: 22px; margin-bottom: 3px; word-break: break-all">${doc.data().title}</h3>
                          <p class="text-muted" style="margin:0; color: #aaa; font-weight: lighter">${(doc.data().name) || "User"} - ${doc.data().timeOfPost ? moment(doc.data().timeOfPost.toDate()).fromNow() : moment().fromNow()}</p>
                      </div>
                  </div>
                  <br>
                  <div class="description">
                      <p class="text-muted" style="word-break: break-all">${doc.data().description}</p>
                  </div>
                  <div style="display:flex; border-top: 1px solid #f6f6f6; padding-top: 10px; align-items: center; justify-content: flex-end">
                  <i class="fa-solid fa-heart"
id="heart-${doc.id}"
onclick="addToLike('${doc.id}')"
style="color: ${doc.data().likedBy && doc.data().likedBy.includes(auth.currentUser.uid) ? 'red' : '#7749F8'}; font-size: 18px; cursor: pointer">
</i>
<h4 id="likes-${doc.id}" style="font-size: 16px; font-weight: lighter; margin: 0; margin-left: 10px; color: #7749F8">${doc.data().likes || 0}</h4>
              </div>
          </div>
      </div>
      <br>
  </div>
  <br>
</div>`
        })
    onSnapshot(doc.ref, (snapshot) => {
        try {
            const updatedData = snapshot.data();
            const likesElement = document.getElementById(`likes-${doc.id}`);
            if (likesElement) {
                likesElement.innerText = updatedData.likes || 0;
            }
            const heartIcon = document.getElementById(`heart-${doc.id}`);
            if (heartIcon) {
                heartIcon.style.color = updatedData.likedBy && updatedData.likedBy.includes(auth.currentUser.uid) ? '#ff0000' : '#7749f8';
            }
        } catch (error) {
            console.error('Error updating like status:', error);
        }
    });
});
function goTo(id, url) {
    localStorage.setItem("id", id)
    localStorage.setItem("url", url)
    location.replace("../pages/seperate.html")
}
window.goTo = goTo

const time = new Date().getHours();
let greeting;

if (time < 4) {
    greeting = "Good Night";
} else if (time < 10) {
    greeting = "Good Morning";
} else if (time < 14) {
    greeting = "Good Noon";
} else if (time < 18) {
    greeting = "Good Afternoon";
} else if (time < 20) {
    greeting = "Good Evening";
} else {
    greeting = "Good Night";
}

document.getElementById("greeting").innerHTML = `${greeting} Readers !`;

onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById("l").innerHTML = 'signup'
        document.getElementById("l").href = "./pages/./signup/./signup.html"
    }
})


async function addToLike(id) {
    const postRef = doc(db, "blogs", id);
    const postSnapshot = await getDoc(postRef);
    const postData = postSnapshot.data();

    if (postData.likedBy && postData.likedBy.includes(auth.currentUser.uid)) {
        await updateDoc(postRef, {
            likes: Math.max((postData.likes || 0) - 1, 0),
            likedBy: postData.likedBy.filter(userId => userId !== auth.currentUser.uid)
        });
    } else {
        await updateDoc(postRef, {
            likes: (postData.likes || 0) + 1,
            likedBy: [...(postData.likedBy || []), auth.currentUser.uid]
        });
    }
}
window.addToLike = addToLike

function hasLikedPost(postId) {
    const likedPosts = JSON.parse(localStorage.getItem("likedPosts")) || [];
    return likedPosts.includes(postId);
}

function updateLikedPosts(postId) {
    const likedPosts = JSON.parse(localStorage.getItem("likedPosts")) || [];
    if (hasLikedPost(postId)) {
        localStorage.setItem(
            "likedPosts",
            JSON.stringify(likedPosts.filter((id) => id !== postId))
        );
    } else {
        localStorage.setItem("likedPosts", JSON.stringify([...likedPosts, postId]));
    }
}



         
       </script>
</body>

</html>